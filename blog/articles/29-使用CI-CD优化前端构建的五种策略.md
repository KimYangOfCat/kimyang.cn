---
title: "ä½¿ç”¨ CI/CD ä¼˜åŒ–å‰ç«¯æ„å»ºçš„äº”ç§ç­–ç•¥"
date: 2021-06-02
tags: [CI/CD, å‰ç«¯]
categories: [ğŸŒ ç¿»è¯‘æ ¡å¯¹]
---

![](https://picbed.kimyang.cn/202109050835496.jpeg)

å¦‚ä»Šä½¿ç”¨ CI/CD å·¥å…·æ˜¯ç½‘é¡µåº”ç”¨ç¨‹åºå¼€å‘çš„ä¸€ä¸ªå¿…è¦æ¡ä»¶ã€‚ä½œä¸ºå…³é”®å¼€å‘è·¯å¾„çš„ä¸€éƒ¨åˆ†ï¼ŒåŠ å¿«æ„å»ºç³»ç»Ÿçš„é€Ÿåº¦å¯¹äºæé«˜å¼€å‘äººå‘˜çš„ç”Ÿäº§æ•ˆç‡æ˜¯è‡³å…³é‡è¦çš„ã€‚<!-- more -->

å› æ­¤ï¼Œåœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬å°†å¸¦ä½ äº†è§£äº”ç§ä½¿ç”¨ CI/CD ä¼˜åŒ–å‰ç«¯æ„å»ºæ—¶é—´çš„ä¸åŒç­–ç•¥ã€‚

## 1. ä½¿ç”¨å¹¶è¡Œç½‘ç»œåŒ… Parallel-Webpack

> Parallel-Webpack è®©ä½ èƒ½å¤Ÿä¸€è¾¹è¿è¡Œä¸€è¾¹è¿›è¡Œæ„å»ºåº”ç”¨ç¨‹åºï¼Œä»¥å‡å°‘åº”ç”¨ç¨‹åºæ„å»ºæ—¶é—´ã€‚

ä½ å¯ä»¥é€šè¿‡ä½¿ç”¨ä»¥ä¸‹ NPM å‘½ä»¤è½»æ¾å¼€å§‹ä½¿ç”¨ Parallel-Webpackï¼š

```bash
npm install parallel-webpack â€”-save-dev
```

ä¸ºäº†æ›´å¥½åœ°äº†è§£ Parallel-Webpack çš„é…ç½®ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸ªç®€å•çš„ç¤ºä¾‹ã€‚

```js
var path = require("path");
module.exports = [
  {
    entry: "./firstjob.js",
    output: {
      path: path.resolve(__dirname, "./dist"),
      filename: "task1.bundle.js",
    },
  },
  {
    entry: "./secondjob.js",
    output: {
      path: path.resolve(__dirname, "./dist"),
      filename: "task2.bundle.js",
    },
  },
];
```

ä¸Šé¢çš„é…ç½®åŒ…æ‹¬ä¸¤ä¸ªç‹¬ç«‹çš„æ„å»ºä»»åŠ¡ï¼Œåˆ†åˆ«æ˜¯ `firstjob` å’Œ `secondjob`ã€‚Parallel-Webpack ä¼šåŒæ—¶è¿è¡Œè¿™ä¸¤ä¸ªæ„å»ºä»»åŠ¡ï¼Œä½ ä¼šå‘ç° `task1.bundle.js` å’Œ `task2.bundle.js` åŒæ—¶è¢«æ„å»ºã€‚

> Parallel-Webpack å…è®¸ä½ æ§åˆ¶å¹¶è¡Œæ€§ï¼ŒåŒ…æ‹¬ Webpack çš„æ™®é€šåŠŸèƒ½ï¼Œä¾‹å¦‚è§‚å¯Ÿè€…ï¼ˆwatcherï¼‰å’Œé‡ä¼ é™åˆ¶ï¼ˆretry limitï¼‰ã€‚

### æ§åˆ¶å¹¶è¡Œæ€§

æœ‰æ—¶ï¼Œä½ å¯èƒ½æƒ³é™åˆ¶ Parallel-Webpack å¯ç”¨çš„ CPU æ ¸å¿ƒæ•°é‡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯ä»¥ä½¿ç”¨ `parallel-webpack -p=2` å‘½ä»¤æŒ‡å®šå¯ç”¨çš„ CPU æ ¸å¿ƒæ•°é‡ã€‚

### è¿è¡Œè§‚å¯Ÿè€…

è®© Webpack å¦‚æ­¤æœ‰å½±å“åŠ›çš„åŠŸèƒ½ä¹‹ä¸€æ˜¯å®ƒçš„è§‚å¯Ÿè€…ï¼Œå®ƒå¯ä»¥æŒç»­åœ°é‡å»ºä½ çš„åº”ç”¨ç¨‹åºã€‚ä½ å¯ä»¥åœ¨ Parallel-Webpack ä¸­æ¯«ä¸è´¹åŠ›åœ°ä½¿ç”¨åŒæ ·çš„åŠŸèƒ½ï¼Œåªè¦åœ¨å‘½ä»¤ä¸­åŠ å…¥ watch æ ‡å¿—å³å¯ã€‚

```bash
parallel-webpack --watch
```

åŒæ ·åœ°ï¼ŒParallel-Webpack ä¸­æœ‰è®¸å¤šä»¤äººå…´å¥‹çš„åŠŸèƒ½ï¼Œå¯ä»¥é›†æˆåˆ°ä½ çš„ CI/CD ç®¡é“ä¸­ï¼Œä»¥ä¾¿åŠ å¿«å®ƒçš„é€Ÿåº¦ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨[æ–‡æ¡£](https://github.com/trivago/parallel-webpack)ä¸­æ‰¾åˆ°æ›´å¤šæœ‰å…³ä¿¡æ¯ã€‚

## 2. å°†åº”ç”¨ç¨‹åºæ‹†åˆ†æˆå¾®å‰ç«¯

å‡è®¾è€ƒè™‘ä¼ ç»Ÿçš„å•ä½“å‰ç«¯ç³»ç»Ÿï¼Œå®ƒä»¬ä¸­çš„å¤§éƒ¨åˆ†æ˜¯åªæœ‰ä¸€ä¸ªæ„å»ºç®¡é“å’Œä¸€ä¸ªå‘å¸ƒç®¡é“ã€‚å› æ­¤ï¼Œå¦‚æœæœ‰ä¸€ä¸ªé”™è¯¯ä¿®å¤æˆ–æ–°åŠŸèƒ½æ›´æ–°ï¼Œå°±æœ‰å¯èƒ½ç ´å CI/CD ç®¡é“ä¸­çš„æ•´ä¸ªæ„å»ºé˜¶æ®µã€‚

ç„¶è€Œï¼Œå¦‚æœæˆ‘ä»¬ä½¿ç”¨å¾®å‰ç«¯ï¼Œæˆ‘ä»¬å¯ä»¥å°†åº”ç”¨ç¨‹åºçš„åŠŸèƒ½æ‹†åˆ†ï¼Œå¹¶ç‹¬ç«‹ç»´æŠ¤åº”ç”¨ç¨‹åºçš„æ„å»ºå’Œå‘å¸ƒç®¡é“ï¼Œä»¥ä¾¿ä¸æ–­æäº¤æ›´æ–°å’Œä¿®å¤é”™è¯¯ã€‚

![Micro Frontend Architecture](https://picbed.kimyang.cn/202109050835881.png)

é€šå¸¸ï¼Œå¯ä»¥ç‹¬ç«‹åœ°æ•´åˆå’Œéƒ¨ç½²æ¯ä¸ªåº”ç”¨ç¨‹åºï¼Œè®©ä½ æ›´å¿«åœ°ä¿®å¤é‡è¦åŠŸèƒ½ã€‚å› æ­¤ï¼Œè¿™ç¡®å®å¯¹ CI/CD æµç¨‹çš„æé€Ÿæœ‰å¾ˆå¤§å¸®åŠ©ã€‚

## 3. ç»„ä»¶é©±åŠ¨å‹ CIï¼šRipple CI

ç»„ä»¶é©±åŠ¨å‹ CI æ˜¯æŒ‡åªåœ¨ä¿®æ”¹è¿‡çš„ç»„ä»¶å’Œå®ƒä»¬çš„æ‰€æœ‰ä¾èµ–å…³ç³»ï¼ˆå³å—å½±å“çš„ç»„ä»¶ï¼‰ä¸Šè¿è¡Œçš„ CIï¼Œå®ƒä¸æŠŠæ•´ä¸ªé¡¹ç›®ä½œä¸ºä¸€ä¸ªå•ç‹¬å®ä½“ã€‚Ripple CI çš„å…¸å‹ç¤ºä¾‹æ˜¯ [Bit](https://gihub.com/teambit/bit)ã€‚

## 4. ä¼˜åŒ– Webpack çš„æ€§èƒ½

æˆ‘ä»¬é€šå¸¸ä½¿ç”¨ Webpack çš„é»˜è®¤è®¾ç½®ã€‚ç„¶è€Œï¼Œä½ æ˜¯å¦çŸ¥é“å¦‚ä½•é€šè¿‡ä½¿ç”¨æ’ä»¶å’Œè‡ªå®šä¹‰é…ç½®è¿›ä¸€æ­¥ä¼˜åŒ–å®ƒå—ï¼Ÿ

### ä½¿ç”¨ `uglifyjs-webpack-plugin v1` æ’ä»¶

å‹ç¼©æ˜¯æŒ‡åœ¨ä½ çš„ç½‘é¡µä¸­å‹ç¼©ä»£ç ã€æ ‡è®°å’Œè„šæœ¬æ–‡ä»¶çš„è¿‡ç¨‹ã€‚å®ƒæ˜¯å‡å°‘æ„å»ºæ—¶é—´çš„ä¸»è¦æ–¹æ³•ä¹‹ä¸€ã€‚

ä½†æ˜¯ï¼Œéšç€é¡¹ç›®è§„æ¨¡çš„æ‰©å¤§ï¼Œè¿™ä¸ªä¿®æ”¹è¿‡ç¨‹æœ¬èº«ä¹Ÿä¼šèŠ±è´¹ç›¸å½“å¤šçš„æ—¶é—´ã€‚

å¦‚æœé¡¹ç›®æ­£åœ¨æ„å»ºï¼Œå¯ä»¥ä½¿ç”¨æ’ä»¶ `uglifyjs-webpack-plugin v1` æ¥ä¼˜åŒ–æ„å»ºæ—¶é—´ã€‚è¿™ä¸ªæ’ä»¶æä¾›äº†å¤šè¿›ç¨‹å¹¶è¡Œè¿è¡Œçš„èƒ½åŠ›å’Œç¼“å­˜æ”¯æŒï¼Œå¤§å¤§æå‡äº†æ„å»ºæ•ˆç‡ã€‚

### åœ¨å‹ç¼©æ¨¡å—çš„è¿‡ç¨‹ä¸­ä½¿ç”¨åŠ è½½å™¨

Webpack ä½¿ç”¨åŠ è½½å™¨å°†å…¶ä»–ç±»å‹çš„æ–‡ä»¶è½¬åŒ–ä¸ºæœ‰æ•ˆæ¨¡å—ã€‚ç„¶åï¼Œè¿™äº›æ¨¡å—è¢«åº”ç”¨ç¨‹åºæ¥æ”¶ï¼Œå¹¶æ·»åŠ åˆ°ä¾èµ–å…³ç³»å›¾ä¸­ã€‚

> å› æ­¤ï¼Œå¿…é¡»æŒ‡å®šç›¸å…³çš„æ–‡ä»¶ç›®å½•ï¼Œä»¥å‡å°‘ä¸å¿…è¦çš„æ¨¡å—åŠ è½½ã€‚

åœ¨ Webpack é…ç½®ä¸­ï¼Œä½ å¯ä»¥é€šè¿‡ `include` é€‰é¡¹è½»æ¾æŒ‡å®šæ–‡ä»¶ç›®å½•ã€‚

```js
const path = require("path");

module.exports = {
  //...
  module: {
    rules: [
      {
        test: /\.js$/,
        include: path.resolve(__dirname, "src"),
        loader: "css-loader",
      },
    ],
  },
};
```

## 5. NPM æ¨¡å—å®‰è£…çš„ç®¡é“ç¼“å­˜

æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œå®‰è£…èŠ‚ç‚¹æ¨¡å—éœ€è¦è€—è´¹æ—¶é—´ã€‚æˆ‘ä»¬å‘ç°äº†è¿™ä¸ªé—®é¢˜ï¼Œç‰¹åˆ«æ˜¯åœ¨ç®¡é“ä¸­è€—è´¹æ›´å¤šæ—¶é—´ï¼Œå› ä¸ºå®ƒä»¬æ¯æ¬¡è¿è¡Œéƒ½ä¼šå®‰è£…èŠ‚ç‚¹æ¨¡å—ã€‚

> NPM ç¼“å­˜æ˜¯ä¸€ç§ç®€å•çš„ç¼“å­˜æœºåˆ¶ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ„å»ºç®¡é“ä¸­ä½¿ç”¨ï¼Œä»¥é¿å…æ¯æ¬¡éƒ½è¿è¡Œ npm å®‰è£…ã€‚

è¿™ç§ç¼“å­˜æœºåˆ¶å°†ä½¿ä½ çš„æ„å»ºç®¡é“ä¸ä½ çš„æœ¬åœ°å¼€å‘ç¯å¢ƒç›¸ä¼¼ã€‚ä½ åªéœ€è¦å®‰è£…ä¸€æ¬¡èŠ‚ç‚¹æ¨¡å—ï¼ŒåŒæ ·çš„æ¨¡å—å°†è¢«ç”¨äºåç»­çš„æ„å»ºã€‚

ä¾‹å¦‚ï¼Œè®©æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ª NodeJS é¡¹ç›®çš„ Azure DevOps ç®¡é“ã€‚

ä¸º NodeJs é¡¹ç›®ç¼“å­˜ NPM æ¨¡å—çš„æœ€æ¨èæ–¹å¼æ˜¯ä½¿ç”¨ NPM çš„[å…±äº«ç¼“å­˜ç›®å½•](https://docs.npmjs.com/misc/config#cache)ã€‚è¿™ä¸ªç›®å½•åŒ…æ‹¬æ‰€æœ‰ä¸‹è½½æ¨¡å—çš„ç¼“å­˜ç‰ˆæœ¬ã€‚æ¯å½“æˆ‘ä»¬è¿è¡Œ `npm install` å‘½ä»¤æ—¶ï¼ŒNPM ä¼šé¦–å…ˆæ£€æŸ¥è¿™ä¸ªç›®å½•ï¼Œå¹¶åœ¨å…¶ä¸­è·å–å­˜å‚¨çš„åŒ…ã€‚

**ç¤ºä¾‹ä»£ç **

```yml
variables:
npm_config_cache: $(Pipeline.Workspace)/.npm

steps:
â€” task: Cache@2
  inputs:
    key: â€˜npm | â€œ$(Agent.OS)â€ | package-lock.jsonâ€™
    restoreKeys: |
      npm | â€œ$(Agent.OS)â€
    path: $(npm_config_cache)
  displayName: Cache npm

â€” script: npm ci
```

## æœ¬æ–‡æ€»ç»“

æ­£å¦‚ä½ å·²ç»äº†è§£åˆ°çš„ï¼Œæœ‰äº”ç§æŠ€æœ¯å¯ä»¥åŠ å¿«å‰ç«¯åº”ç”¨ç¨‹åºçš„æ„å»ºæ—¶é—´ã€‚æ­¤å¤–ï¼Œè¿˜æœ‰è®¸å¤šå…¶ä»–æŠ€æœ¯å¯èƒ½é€‚åˆæŠ€æœ¯å¼€å‘å’Œå·¥ä½œæµç¨‹ã€‚ä½ åº”è¯¥é€‰æ‹©é€‚åˆç”¨ä¾‹çš„æ–¹æ³•ã€‚

åŒæ—¶ï¼Œæˆ‘å¸Œæœ›è¿™é‡Œçš„è®¨è®ºèƒ½å¸®åŠ©ä½ ç†è§£ä»¥ä¸Šç­–ç•¥ï¼Œä»¥åŠ å¿« CI/CD æµç¨‹çš„å‰ç«¯æ„å»ºæ—¶é—´ã€‚

æ„Ÿè°¢ä½ çš„é˜…è¯»ï¼

---

- åŸæ–‡åœ°å€ï¼š[5 Strategies to Reduce Frontend Build Time with CI/CD](https://blog.bitsrc.io/5-strategies-to-reduce-frontend-build-time-with-ci-cd-3ce429304d1a)
- åŸæ–‡ä½œè€…ï¼š[Bhagya Vithana](https://medium.com/@bhagya-16)
- è¯‘æ–‡å‡ºè‡ªï¼š[æ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
- æœ¬æ–‡æ°¸ä¹…é“¾æ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/article/2021/5-strategies-to-reduce-frontend-build-time-with-ci-cd.md](https://github.com/xitu/gold-miner/blob/master/article/2021/5-strategies-to-reduce-frontend-build-time-with-ci-cd.md)
- è¯‘è€…ï¼š[Zz æ‹›é”¦](https://github.com/zenblo)
- æ ¡å¯¹è€…ï¼š[Kim Yang](https://github.com/KimYangOfCat)ã€[Kimhooo](https://github.com/Kimhooo)
