---
title: "ã€è¯‘ã€‘ä½¿ç”¨ Web Workers æ¥åŠ é€Ÿ JavaScript åº”ç”¨"
date: 2021-05-25
tags: [JavaScript,å‰ç«¯]
categories: [ðŸŒ ç¿»è¯‘æ ¡å¯¹]
---
# ä½¿ç”¨ Web Workers æ¥åŠ é€Ÿ JavaScript åº”ç”¨

![](https://cdn-images-1.medium.com/max/5760/1*dc6I4-IzvGDNryL2KpZX-Q.png)

Web Workers æ˜¯ä¸€ç§å¯ä»¥è°ƒç”¨æµè§ˆå™¨åœ¨åŽå°æ‰§è¡Œå¤§é‡ä¸”è€—æ—¶ä»»åŠ¡çš„æ–¹æ³•ã€‚å®ƒæ‹¥æœ‰å¼€å¯æ–°çº¿ç¨‹çš„èƒ½åŠ›ï¼Œä»Žè€Œå…è®¸ä½ ä¼˜å…ˆå¤„ç†æŸäº›ä»»åŠ¡ï¼Œå¹¶å¯ä»¥è§£å†³å¦‚ JavaScript è¿™ç±»å•çº¿ç¨‹è¯­è¨€ä¸­çš„é˜»å¡žè¡Œä¸ºã€‚

ä½†æ˜¯æˆ‘ä»¬çœŸçš„éœ€è¦å¤šçº¿ç¨‹çš„ JavaScript å—ï¼Ÿä¸ºäº†å›žç­”è¿™ä¸ªé—®é¢˜ï¼Œè®©æˆ‘ä»¬å…ˆæ¥ç†è§£å•çº¿ç¨‹ JavaScript çš„å±€é™æ€§åœ¨å“ªã€‚

## å•çº¿ç¨‹ JavaScript çš„å±€é™æ€§

çŽ°ä»£ç½‘ç»œåº”ç”¨ç¨‹åºå¯¹æµè§ˆå™¨æå‡ºäº†æ›´é«˜çš„è¦æ±‚ã€‚å…¶ä¸­ä¸€äº›ä»»åŠ¡æ˜¯éœ€è¦é•¿æ—¶é—´è¿è¡Œçš„ï¼Œè€Œè¿™å¯èƒ½ä¼šå¯¼è‡´ç”¨æˆ·ç•Œé¢å†»ç»“å‡ ç§’é’Ÿã€‚ä¸ç®¡æ€Žæ ·ï¼Œè¿™å¯¹ç”¨æˆ·ä½“éªŒéƒ½æ˜¯ä¸å¥½çš„ã€‚

ä¸ºäº†è®©ä½ æ›´å¥½çš„ç†è§£ï¼Œæˆ‘åˆ›å»ºäº†ä¸€ä¸ªç¤ºä¾‹åº”ç”¨ç¨‹åºï¼Œåœ¨æµè§ˆå™¨ä¸­æ¨¡æ‹Ÿå®ƒã€‚å…¶ä¸­ `Start_Animation` æŒ‰é’®åŠŸèƒ½æ˜¯å°†è‡ªè¡Œè½¦å‘å‰ç§»åŠ¨ï¼Œ`Run_Calculation` æŒ‰é’®çš„å¯åŠ¨ä¼šæ¶ˆè€—å¤§é‡ CPU èµ„æºæ¥è®¡ç®—ç¨‹åºä¸­çš„è´¨æ•°åºåˆ—ã€‚

```JavaScript
const prime = (num) => {
  for (let i = 0; i <= num; i++) {
    let flag = 0;
  
    // ä»Ž 2 å¼€å§‹å¾ªçŽ¯åˆ°ç”¨æˆ·è¾“å…¥çš„æ•°å­—
    for (let j = 2; j < i; j++) {
        if (i % j == 0) {
            flag = 1;
            break;
        }
    }
  
    // å¦‚æžœ number å¤§äºŽ 1 ä¸”ä¸èƒ½è¢«å…¶ä»–æ•°å­—æ•´é™¤
    if (i > 1 && flag == 0) {
        console.log(i);
    }
  }
};

const Run_Calculation = () => {
  const num = 50000;
  console.log(prime(num));
  return prime(num);
};

const Start_Animation = () => {
  for (let i = 0; i < 3; i++) {
    const shuttleID = `shuttle${i + 1}`;
    let shuttle = document.getElementById(shuttleID);

    let position = 0;
    setInterval(() => {
      if (position > window.innerWidth / 1.2) {
        position = 0;
      } else {
        position++;
        shuttle.style.left = position + "px";
      }
    }, 1);
  }
};

```

è¿è¡Œä¸Šè¿°ä»£ç ï¼Œä½ å°†ä¼šçœ‹åˆ°å¦‚ä¸‹çš„è¾“å‡ºã€‚å¦‚æžœä»”ç»†è§‚å¯Ÿï¼Œä½ ä¼šå‘çŽ°å½“ä½ è°ƒç”¨ `Run_Calculation` å‡½æ•°æ—¶ï¼ŒåŠ¨ç”»ä¼šå†»ç»“å‡ ç§’é’Ÿã€‚

![ä¸€ä¸ªæ²¡æœ‰ä½¿ç”¨ Web Worker çš„åº”ç”¨ç¨‹åºç¤ºä¾‹](https://cdn-images-1.medium.com/max/2280/1*ccudXc7quomjAc-4KQ2Wrg.gif)

æ—¢ç„¶ä½ å·²ç»å¯Ÿè§‰åˆ°å•çº¿ç¨‹ JavaScript çš„å±€é™æ€§ï¼Œè®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Web Workers æ¥å¤„ç†è¿™ä¸ªé—®é¢˜ã€‚

## ä½¿ç”¨é›†æˆ Web Worker çš„ JavaScript

è®©æˆ‘ä»¬çœ‹çœ‹å¦‚ä½•ä½¿ç”¨ Web Worker ä¼˜åŒ–ä¸Šè¿°ä»£ç ã€‚

### ç¬¬ä¸€æ­¥ â€” åˆ†è§£å‡½æ•°åŠŸèƒ½

ä¸Šè¿°ä¾‹å­ä¸»è¦æœ‰ä¸¤ä¸ªå‡½æ•°ï¼š`Run_Calculation` å’Œ `Start_Animation`ã€‚å› ä¸ºåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­è¿è¡Œä¸¤ä¸ªå‡½æ•°ä¼šå¯¼è‡´å…¶ä¸­ä¸€ä¸ªå†»ç»“ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å°†è¿™ä¸¤ä¸ªå‡½æ•°åˆ†ç¦»ï¼Œå¹¶åœ¨ä¸åŒçº¿ç¨‹ä¸­è¿è¡Œå®ƒä»¬ã€‚

å› æ­¤ï¼Œæˆ‘åˆ›å»ºæ¥ä¸€ä¸ªåä¸º worker.js çš„æ–°æ–‡ä»¶ï¼Œå¹¶å°†è´¨æ•°ç”Ÿæˆçš„æ¨¡å—è½¬ç§»åˆ°é‚£é‡Œã€‚

> ä¸º Web Workers åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ Javascript æ–‡ä»¶æ˜¯å¿…è¦çš„ã€‚å› ä¸ºä¸»çº¿ç¨‹å’Œ web worker è„šæœ¬å¿…é¡»å®Œå…¨ç‹¬ç«‹ï¼Œæ‰èƒ½åœ¨ä¸åŒçš„çº¿ç¨‹ä¸Šæ“ä½œã€‚

å¦‚æžœä¸è¿™æ ·åšï¼Œä½ å°†æ— æ³•ä¿è¯æ‰§è¡Œä¸Šä¸‹æ–‡çš„çº¿ç¨‹å®Œå…¨å®‰å…¨ï¼Œå¹¶ä¸”å®ƒä»¬å¯èƒ½åœ¨å¹¶è¡Œæ‰§è¡Œè¿‡ç¨‹ä¸­å¯¼è‡´æ„å¤–çš„é”™è¯¯ã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼Œweb worker æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­åˆ›å»ºçš„ã€‚å› æ­¤ï¼Œä½ éœ€è¦è°ƒç”¨ [Worker()](https://developer.mozilla.org/en-US/docs/Web/API/Worker/Worker) æž„é€ å‡½æ•°ï¼Œæ¥æŒ‡å®šè„šæœ¬åœ¨ worker çº¿ç¨‹ä¸­çš„æ‰§è¡Œä½ç½®ã€‚

```JavaScript
let worker = new Worker("./worker.js");

const Run_Calculation = () => {
  const num = 50000;
  worker.postMessage(num);
};

worker.onmessage = event => {
  const num = event.data;
  console.log(num);
};

const Start_Animation = () => {
  for (let i = 0; i < 3; i++) {
    const bikeID = `bike${i + 1}`;
    let bike = document.getElementById(bikeID);

    let position = 0;
    setInterval(() => {
      if (position > window.innerWidth / 1.2) {
        position = 0;
      } else {
        position++;
        bike.style.left = position + "px";
      }
    }, 5);
  }
};
```

æˆ‘ç›¸ä¿¡ä½ ä¸€å®šæ³¨æ„åˆ°ï¼Œé™¤äº†ä¹‹å‰æˆ‘ä»¬è®¨è®ºçš„å‡½æ•°ä¿®æ”¹å¤–ï¼Œè¿˜æœ‰å…¶ä»–çš„ä¸€äº›ä¿®æ”¹ã€‚ä¸ç”¨æ‹…å¿ƒï¼Œæˆ‘ä»¬å°†åœ¨æŽ¥ä¸‹æ¥çš„æ­¥éª¤ä¸­è§£é‡Šå®ƒä»¬ã€‚

### ç¬¬äºŒæ­¥ â€” å®žçŽ°ä¸¤ä¸ªæ–‡ä»¶ä¹‹é—´é€šä¿¡

çŽ°åœ¨ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªå•ç‹¬çš„è„šæœ¬ï¼Œæˆ‘ä»¬éœ€è¦å®žçŽ°ä¸€ç§åœ¨è¿™ä¸¤ä¸ªè„šæœ¬ä¹‹é—´é€šä¿¡çš„æ–¹æ³•ã€‚ä¸ºæ­¤ï¼Œä½ éœ€è¦äº†è§£å¦‚ä½•åœ¨ä¸»çº¿ç¨‹å’Œ web worker çº¿ç¨‹ä¹‹é—´è¿›è¡Œæ•°æ®ä¼ é€’ã€‚

> Web Worker API æœ‰ä¸€ä¸ª `postMessage()` æ–¹æ³•ç”¨æ¥å‘é€æ¶ˆæ¯ï¼Œè¿˜æœ‰ä¸€ä¸ª `onmessage `äº‹ä»¶ç”¨æ¥æŽ¥æ”¶æ¶ˆæ¯ã€‚

å¦‚æžœæˆ‘ä»¬è€ƒè™‘è¿™æ ·ä¸€ç§åœºæ™¯ã€‚æˆ‘ä»¬éœ€è¦ä»Ž web worker çº¿ç¨‹ä¼ é€’æ¶ˆæ¯åˆ°ä¸»çº¿ç¨‹ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨ worker æ–‡ä»¶ä¸­ä½¿ç”¨ `postMessage()` å‡½æ•°ï¼Œå¹¶ä¸”ä½¿ç”¨ `worker.onmessage` åœ¨ä¸»çº¿ç¨‹ä¸­ç›‘å¬æ¥è‡ª worker çš„æ¶ˆæ¯ã€‚

åŒç†ï¼Œè¿™äº›ç›¸åŒçš„å‡½æ•°ä¹Ÿå¯ä»¥ç”¨äºŽå°†æ•°æ®ä»Žä¸»çº¿ç¨‹ä¼ é€’åˆ° web worker çº¿ç¨‹ä¸­ã€‚æˆ‘ä»¬éœ€è¦åšçš„å”¯ä¸€åŒºåˆ†æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­è°ƒç”¨ `worker.postMessage()` æ–¹æ³•ï¼Œåœ¨ worker çº¿ç¨‹ä¸­è°ƒç”¨ `onmessage` ç›‘å¬äº‹ä»¶ã€‚

> **æç¤ºï¼š** é‡è¦çš„æ˜¯è¦è®°ä½ `onmessage` å’Œ `postMessage()` åœ¨ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨è€Œéž worker çº¿ç¨‹æ—¶ï¼Œéœ€è¦æŒ‚åœ¨ worker å¯¹è±¡ä¸Šï¼Œä½†å¦‚æžœä¸åœ¨ worker çº¿ç¨‹ä¸­ï¼Œè¿™å°†ä¼šæé«˜ worker çš„æ•ˆçŽ‡ï¼ŒåŒæ—¶ç¡®ä¿å®‰å…¨çš„**è·¨åŸŸé€šä¿¡**ã€‚

å¦‚ä½ æ‰€è§ï¼Œæˆ‘ä½¿ç”¨ `onmessage` äº‹ä»¶å’Œ `postMessage()` å‡½æ•°ä¿®æ”¹äº†ä¸¤ä¸ªæ–‡ä»¶ï¼Œä»Žè€Œå»ºç«‹èµ·ä¸»çº¿ç¨‹å’Œ web worker çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€‚

```JavaScript
//worker.js æ–‡ä»¶
self.onmessage = event => { 
  const num = event.data; 
  const result = prime(num); 
  self.postMessage(result); 
  self.close();
};

//main_scrpit.js
let worker = new Worker(â€œ./worker.jsâ€); 

const Run_Calculation = () => { 
  const num = 50000; 
  worker.postMessage(num);
}; 

worker.onmessage = event => { 
  const num = event.data;
};
```

> **å¤‡æ³¨ï¼š** å½“æ¶ˆæ¯åœ¨ä¸»çº¿ç¨‹å’Œ worker ä¹‹é—´ä¼ é€’æ—¶ï¼Œå®ƒå°†å®Œå…¨è¢«ç§»é™¤è€Œéžå…±äº«ã€‚

çŽ°åœ¨ï¼Œä¸€åˆ‡éƒ½è®¾ç½®å¥½äº†ï¼Œä½ å¯ä»¥åœ¨æµè§ˆå™¨ä¸­é‡æ–°åŠ è½½ç¨‹åºï¼Œå¯åŠ¨åŠ¨ç”»ï¼Œå¹¶ç‚¹å‡» `Run_Calculation` æŒ‰é’®å¼€å§‹è®¡ç®—ã€‚ä½ ä¼šçœ‹åˆ°è´¨æ•°è®¡ç®—ç»“æžœä»ç„¶å‡ºçŽ°åœ¨æµè§ˆå™¨æŽ§åˆ¶å°ä¸­ï¼Œä½†è¿™å¯¹å›¾åƒçš„ç§»åŠ¨æ²¡æœ‰å½±å“ã€‚å› æ­¤ï¼Œå¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºè¡¨çŽ°æœ‰äº†**å¾ˆå¤§å¹…åº¦çš„æé«˜**ã€‚

![ä¸€ä¸ªä½¿ç”¨ Web Worker åº”ç”¨ç¨‹åºç¤ºä¾‹](https://cdn-images-1.medium.com/max/2280/1*x0judL4Qm9bdKJ8RM4yeyQ.gif)

### ç¬¬ä¸‰æ­¥ â€” ç»ˆæ­¢ web worker

ä½œä¸ºå®žè·µï¼Œæœ€å¥½æ˜¯åœ¨ worker å®Œæˆå…¶åŠŸèƒ½åŽç»ˆæ­¢å®ƒï¼Œå› ä¸ºè¿™ä¼šä¸ºå…¶ä»–åº”ç”¨ç¨‹åºé‡Šæ”¾èµ„æºã€‚ä½ å¯ä»¥ä½¿ç”¨ `terminate()` å‡½æ•°æˆ–è€… `close()` å‡½æ•°æ¥å®žçŽ°ç»ˆæ­¢ã€‚

> ç„¶è€Œï¼Œå¿…é¡»çŸ¥é“ä½•æ—¶åœ¨ terminate () å’Œ close() æ–¹æ³•ä¹‹é—´è¿›è¡Œé€‰æ‹©ï¼Œå› ä¸ºå®ƒä»¬æœ‰ä¸åŒçš„ç”¨å¤„ã€‚

`close()` å‡½æ•°åªåœ¨ worker æ–‡ä»¶ä¸­å¯è§ã€‚å› æ­¤ï¼Œå®ƒåªèƒ½åœ¨ worker æ–‡ä»¶ä¸­ç»ˆæ­¢ workerã€‚å¦ä¸€æ–¹é¢ï¼Œ`terminate()` æ–¹æ³•æ˜¯ worker å¯¹è±¡æŽ¥å£çš„ä¸€éƒ¨åˆ†ï¼Œä½ å¯ä»¥ä»Žä¸» JavaScript æ–‡ä»¶ä¸­è°ƒç”¨å®ƒã€‚

```JavaScript
// ç«‹å³ç»ˆæ­¢ä¸» JS æ–‡ä»¶
worker.terminate();

// ä½¿ç”¨ worker ä¸­ä»£ç åœæ­¢ workerã€‚
self.close();
```

ä½ å¯ä»¥åœ¨æˆ‘çš„ [GitHub](https://github.com/bhagya327/Demo-Application) è´¦å·ä¸­æ‰¾åˆ°å®Œæ•´ç¤ºä¾‹ã€‚

## æœ€åŽçš„æ€è€ƒ

Web Workers æ˜¯ä¸€ç§é€šè¿‡å¯åŠ¨æ–°çº¿ç¨‹æ¥åŠ é€Ÿåº”ç”¨ç¨‹åºçš„ç®€å•æ–¹æ³•ã€‚åœ¨æˆ‘ç»™çš„ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨äº†ä¸€ä¸ªè®¡ç®—é‡å¾ˆå¤§ä»»åŠ¡æ¥å±•ç¤ºä½¿ç”¨ Web Workers çš„å’Œä¸ä½¿ç”¨å®ƒä¹‹é—´çš„å·®å¼‚ç‚¹ã€‚

é™¤æ­¤ä¹‹å¤–ï¼Œè¿˜æœ‰å¾ˆå¤š Web Workers ç”¨ä¾‹ï¼Œæ¯”å¦‚ç¼“å­˜æ•°æ®å’Œç½‘é¡µã€åŽå° I/O æ“ä½œã€åˆ†æžè§†é¢‘æˆ–è€…éŸ³é¢‘æ•°æ®ã€æ‰§è¡Œå‘¨æœŸä»»åŠ¡ç­‰ã€‚

æ›´é‡è¦çš„æ˜¯ï¼Œä½ ä¹Ÿä¸ç”¨æŠŠè‡ªå·±å±€é™äºŽä½¿ç”¨å•ä¸ªçš„ web workerã€‚ä½ å¯ä»¥å¯åŠ¨æ›´å¤šçš„çº¿ç¨‹ï¼Œå¹¶åœ¨å…¶ä¸­å¹¶è¡Œè¿è¡Œä»»åŠ¡ã€‚ä½†æ˜¯æˆ‘ä¸€ç›´å»ºè®®ï¼Œä½ ä¸åº”è¯¥åœ¨æ²¡æœ‰ä»»ä½•éœ€è¦çš„æƒ…å†µä¸‹åˆ›å»º Web Workers ï¼Œè¿™ä¼šäº§ç”Ÿé¢å¤–çš„çº¿ç¨‹ã€‚

åœ¨è¿™ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘è°ˆåˆ°æ¥æˆ‘è‡ªå·±è®¤ä¸ºä½ éœ€è¦äº†è§£çš„å…³äºŽ Web Workers å¤šçº¿ç¨‹çš„æœ€é‡è¦çš„å‡ ç‚¹ã€‚

ä¸€æ—¦ä½ ç†è§£äº† Web Workers çš„å·¥ä½œåŽŸç†ï¼Œå°±å¾ˆå®¹æ˜“ç¡®å®šæ˜¯å¦åœ¨ä½ çš„é¡¹ç›®ä¸­ä½¿ç”¨å®ƒã€‚å› æ­¤ï¼Œæˆ‘é‚€è¯·ä½ ä½“éªŒä¸€ä¸‹ Web Workers çš„å®žé™…ç”¨æ³•ï¼Œå¹¶åœ¨è¯„è®ºåŒºåˆ†äº«ä½ çš„æƒ³æ³•ã€‚ 

æ„Ÿè°¢é˜…è¯»ï¼ï¼ï¼

> * åŽŸæ–‡åœ°å€ï¼š[Using Web Workers to Speed-Up JavaScript Applications](https://blog.bitsrc.io/using-web-workers-to-speed-up-javascript-applications-5c567f209bdb)
> * åŽŸæ–‡ä½œè€…ï¼š[Bhagya](https://medium.com/@bhagya-16)
> * è¯‘æ–‡å‡ºè‡ªï¼š[æŽ˜é‡‘ç¿»è¯‘è®¡åˆ’](https://github.com/xitu/gold-miner)
> * æœ¬æ–‡æ°¸ä¹…é“¾æŽ¥ï¼š[https://github.com/xitu/gold-miner/blob/master/article/2021/using-web-workers-to-speed-up-javascript-applications.md](https://github.com/xitu/gold-miner/blob/master/article/2021/using-web-workers-to-speed-up-javascript-applications.md)
> * è¯‘è€…ï¼š[Usualminds](https://github.com/Usualminds)
> * æ ¡å¯¹è€…ï¼š[Kim Yang](https://github.com/KimYangOfCat)ï¼Œ[Kimhooo](https://github.com/Kimhooo)